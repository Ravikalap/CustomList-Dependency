<!DOCTYPE html>
<html>
<head>
    <title>CustomDepList</title>

    <script type="text/javascript" src="https://rally1.rallydev.com/apps/2.1/sdk.js"></script>

    <script type="text/javascript">
        Rally.onReady(function () {
                (window.Ext4||window.Ext).define("Niks.apps.ParentChildMapper",{extend:Rally.data.wsapi.ParentChildMapper,parentChildTypeMap:null,constructor:function(){this.parentChildTypeMap={hierarchicalrequirement:[{typePath:"defect",collectionName:"Defects",parentField:"Requirement"},{typePath:"hierarchicalrequirement",collectionName:"Predecessors",parentField:"Successors"}],attributedefinition:[{typePath:"allowedattributevalue",collectionName:"AllowedValues",parentField:"AttributeDefinition"}]}},_mergePortfolioItemType:function(e,t){var a=e.TypePath.toLowerCase();this.parentChildTypeMap[a]=[{typePath:a,collectionName:"Predecessors",parentField:"Parent"},{typePath:"testcase",collectionName:"Predecessors",parentField:"Successors"}]}});
                !function(){var e=window.Ext4||window.Ext;e.define("Niks.apps.TreeStoreBuilder",{extend:"Rally.data.wsapi.TreeStoreBuilder",loadModels:function(t){return t.mapper||(t.mapper=e.create("Niks.apps.ParentChildMapper")),this.callParent([t]).then({success:function(e){return t.mapper.initDynamicTypesIfRequired(e,t.context).then({success:function(){return this._setupTreeModel(this._getComponentModels(e),t)},scope:this})},scope:this})}})}();
                !function(){var e=window.Ext4||window.Ext,t=function(e){return{name:e,xtype:"rallytextfield",hidden:!0,handlesEvents:{typeselected:function(){this.setValue(null)}}}};e.define("Niks.apps.Settings",{singleton:!0,requires:["Rally.ui.combobox.FieldComboBox","Rally.ui.combobox.ComboBox","Rally.ui.CheckboxField"],getFields:function(o){return this.app=o,[{name:"type",xtype:"rallycombobox",allowBlank:!1,autoSelect:!1,shouldRespondToScopeChange:!0,context:this.app.getContext(),initialValue:"HierarchicalRequirement",storeConfig:{model:e.identityFn("TypeDefinition"),sorters:[{property:"DisplayName"}],fetch:["DisplayName","ElementName","TypePath","Parent","UserListable"],filters:[{property:"UserListable",value:!0}],autoLoad:!1,remoteSort:!1,remoteFilter:!0},displayField:"DisplayName",valueField:"TypePath",listeners:{select:function(e){this.app.clearFiltersAndSharedViews(),e.fireEvent("typeselected",e.getRecord().get("TypePath"),e.context)},scope:this},bubbleEvents:["typeselected"],readyEvent:"ready",handlesEvents:{projectscopechanged:function(e){this.refreshWithNewContext(e)}}},{type:"query"},{name:"showControls",xtype:"rallycheckboxfield",fieldLabel:"Show Control Bar"},t("columnNames"),t("order")]}})}();
                !function(){var e=window.Ext4||window.Ext;e.define("Niks.apps.CustomListApp",{extend:"Rally.app.GridBoardApp",requires:["Deft.Promise","Niks.apps.Settings","Rally.data.BulkRecordUpdater","Rally.data.ModelTypes","Rally.data.PreferenceManager","Rally.data.util.Sorter","Rally.data.wsapi.Filter","Rally.ui.gridboard.plugin.GridBoardInlineFilterControl","Rally.ui.gridboard.plugin.GridBoardSharedViewControl","Rally.ui.notify.Notifier","Rally.util.String"],disallowedAddNewTypes:["user","userprofile","useriterationcapacity","testcaseresult","task","scmrepository","project","changeset","change","builddefinition","build","program"],orderedAllowedPageSizes:[10,25,50,100,200],readOnlyGridTypes:["build","change","changeset"],statePrefix:"customlist",allowExpansionStateToBeSaved:!1,isEditable:!0,overflowX:"scroll",config:{defaultSettings:{showControls:!0,type:"UserStory, Defect, Milestone"}},initComponent:function(){this.appName="CustomList-"+this.getAppId(),this.defaultSettings.url&&e.apply(this.defaultSettings,{type:this.defaultSettings.url}),this.callParent(arguments)},getSettingsFields:function(){return Niks.apps.Settings.getFields(this)},loadModelNames:function(){return this.modelNames=_.compact(this.getTypeSetting()),this._setColumnNames(this._getColumnNamesSetting()),Deft.Promise.when(this.modelNames)},addGridBoard:function(){this.callParent(arguments),this.getSetting("showControls")||this.gridboard.getHeader().hide()},loadGridBoard:function(){_.isEmpty(this.modelNames)?e.defer(function(){this.fireEvent("settingsneeded",this),this.publishComponentReady()},1,this):(this.enableAddNew=this._shouldEnableAddNew(),this.enableRanking=this._shouldEnableRanking(),this.callParent(arguments))},getGridConfig:function(){var t=_.merge(this.callParent(arguments),{allColumnsStateful:!0,enableEditing:0===_.intersection(this.readOnlyGridTypes,this.getTypeSetting()).length,listeners:{beforestaterestore:this._onBeforeGridStateRestore,beforestatesave:this._onBeforeGridStateSave,scope:this},pagingToolbarCfg:{hidden:!this.getSetting("showControls"),pageSizes:this.orderedAllowedPageSizes}}),i=Rally.util.Filter.findInvalidSubFilters(this._getQueryFilter(),this.models);return i.length&&(t.store.on("beforeload",function(t){return e.defer(function(){t.fireEvent("load",t,t.getRootNode(),[],!0)},1),!1}),this._showInvalidQueryMessage(t,_.map(i,function(e){return'Could not find the attribute "'+e.property.split(".")[0]+'" on type "'+this.models[0].displayName+'" in the query segment "'+e.toString()+'"'},this))),t},getColumnCfgs:function(){return _.union(this.callParent(arguments),_.isEmpty(this.columnNames)&&this.enableRanking?["DragAndDropRank"]:[])},getFilterControlConfig:function(){return _.merge(this.callParent(arguments),{listeners:{beforestaterestore:{fn:this._onBeforeFilterButtonStateRestore,scope:this}}})},getGridBoardCustomFilterControlConfig:function(){var e=this.getContext(),t=this.models[0].isArtifact(),i=t?["ModelType","PortfolioItemType","LastResult"]:["ArtifactSearch","ModelType"],r=t?["Milestones","Tags"]:[];this.models[0].isProject()?i.push("SchemaVersion"):this.models[0].isRelease()&&i.push("ChildrenPlannedVelocity","Version");var n={ptype:"rallygridboardinlinefiltercontrol",inlineFilterButtonConfig:{stateful:!0,stateId:e.getScopedStateId("custom-list-inline-filter"),legacyStateIds:[this.getScopedStateId("owner-filter"),this.getScopedStateId("custom-filter-button")],filterChildren:!0,inlineFilterPanelConfig:{quickFilterPanelConfig:{defaultFields:t?["ArtifactSearch","Owner"]:[],addQuickFilterConfig:{blackListFields:i,whiteListFields:r}},advancedFilterPanelConfig:{advancedFilterRowsConfig:{propertyFieldConfig:{blackListFields:i,whiteListFields:r}}}}}};return t?n.inlineFilterButtonConfig.modelNames=this.modelNames:n.inlineFilterButtonConfig.model=this.models[0],n},getSharedViewConfig:function(){return{ptype:"rallygridboardsharedviewcontrol",sharedViewConfig:{stateful:!0,stateId:this.getContext().getScopedStateId("custom-list-shared-view"),enableUrlSharing:!1!==this.isFullPageApp}}},getGridBoardConfig:function(){var e=this.callParent(arguments);return _.merge(e,{listeners:{viewchange:function(){this.loadGridBoard()},filterchange:function(){this.gridboard.getGridOrBoard().noDataPrimaryText=void 0,this.gridboard.getGridOrBoard().noDataSecondaryText=void 0},scope:this}})},onTreeGridReady:function(e){e.store.getTotalCount()>10&&this.gridboard.down("#pagingToolbar").show(),this.callParent(arguments)},getGridStoreConfig:function(){var e=this._getValidSorters(Rally.data.util.Sorter.sorters(this.getSetting("order")));if(_.isEmpty(e)){var t=this.getContext().getWorkspace().WorkspaceConfiguration.DragDropRankingEnabled?"DragAndDropRank":"Rank",i=Rally.data.ModelTypes.areArtifacts(this.modelNames)?t:Rally.data.util.Sorter.getDefaultSort(this.modelNames[0]);e=Rally.data.util.Sorter.sorters(i)}return{listeners:{warning:{fn:this._onGridStoreWarning,scope:this}},pageSize:10,sorters:e}},getAddNewConfig:function(){return _.merge(this.callParent(arguments),{minWidth:700,openEditorAfterAddFailure:!1,margin:0})},getFieldPickerConfig:function(){return _.merge(this.callParent(arguments),{buttonConfig:{disabled:!this._userHasPermissionsToEditPanelSettings()},gridAlwaysSelectedValues:function(){return[]},gridFieldBlackList:this._shouldEnableRanking()?[]:["Rank"]})},getPermanentFilters:function(){return this._getQueryFilter().concat(this._getTimeboxScopeFilter()).concat(this._getProjectFilter())},onTimeboxScopeChange:function(){this.callParent(arguments),this.loadGridBoard()},clearFiltersAndSharedViews:function(){var t=this.getContext();this.gridboard&&(this.gridboard.down("rallyinlinefilterpanel").clear(),this.gridboard.down("rallysharedviewcombobox").reset()),e.create("Rally.data.wsapi.Store",{model:e.identityFn("preference"),autoLoad:!0,filters:[{property:"AppId",value:t.getAppId()},{property:"Type",value:"View"},{property:"Workspace",value:t.getWorkspace()._ref}],context:t.getDataContext(),listeners:{load:function(t,i){if(!_.isEmpty(i)){var r=e.create("Rally.data.wsapi.batch.Store",{requester:this,data:i});r.removeAll(),r.sync()}t.destroyStore()},scope:this}})},getTypeSetting:function(){return(this.getSetting("type")||this.getSetting("url")||"").toLowerCase().split(",")},_getColumnNamesSetting:function(){return this.getSetting("columnNames")||(this.getSetting("fetch")||"").split(",")},_getQueryFilter:function(){var t=new e.Template(this.getSetting("query")).apply({projectName:this.getContext().getProject().Name,projectOid:this.getContext().getProject().ObjectID,user:this.getContext().getUser()._ref});if(t)try{return[Rally.data.wsapi.Filter.fromQueryString(t)]}catch(e){Rally.ui.notify.Notifier.showError({message:e.message})}return[]},_getProjectFilter:function(){return"milestone"===this.modelNames[0].toLowerCase()?[Rally.data.wsapi.Filter.or([{property:"Projects",operator:"contains",value:this.getContext().getProjectRef()},{property:"TargetProject",operator:"=",value:null}])]:[]},_getTimeboxScopeFilter:function(){var e=this.getContext().getTimeboxScope();return e&&_.any(this.models,e.isApplicable,e)?[e.getQueryFilter()]:[]},_shouldEnableAddNew:function(){return 0===_.intersection(this.disallowedAddNewTypes,this.getTypeSetting()).length},_shouldEnableRanking:function(){return!_.contains(this.getTypeSetting(),"task")},_setColumnNames:function(e){this.columnNames=_.compact(_.isString(e)?e.split(","):e)},_onBeforeFilterButtonStateRestore:function(e,t){if(t&&t.filters&&t.filters.length){var i=_.map(t.filters,function(e){return Rally.data.wsapi.Filter.fromQueryString(e)}),r=Rally.util.Filter.removeNonapplicableTypeSpecificFilters(i,this.models);t.filters=_.invoke(r,"toString")}},_hasViewSelected:function(){var t=this.getSharedViewConfig().sharedViewConfig;if(t&&t.stateId){var i=(e.state.Manager.get(t.stateId)||{}).value;return!_.isEmpty(i)}return!1},_onBeforeGridStateRestore:function(e,t){if(t){if(t.columns){var i=this._getValidUuids(e,this.getColumnCfgs()),r=this._getValidUuids(e,t.columns);if(this._hasViewSelected())t.columns=r;else{var n=_.difference(i,r);n.length>0&&(t.columns=t.columns.concat(n)),t.columns=_.filter(t.columns,function(e){return _.contains(i,_.isObject(e)?e.dataIndex:e)},this)}}t.sorters&&(t.sorters=this._getValidSorters(t.sorters),_.isEmpty(t.sorters)&&delete t.sorters)}},_getValidUuids:function(e,t){return _.reduce(t,function(t,i){var r=this._getColumnDataIndex(i);return this._getModelField(e,r)&&t.push(r),t},[],this)},_getModelField:function(e,t){return e.getModels()[0].getField(t)},_getColumnDataIndex:function(e){return _.isObject(e)?e.dataIndex:e},_onBeforeGridStateSave:function(e,t){var i=this._getColumnNamesFromState(t);_.isEmpty(i)||(this._setColumnNames(i),this._userHasPermissionsToEditPanelSettings()&&this.updateSettingsValues({settings:{columnNames:i.join(",")}}))},_onGridStoreWarning:function(e,t,i){var r=_.filter(t,function(e){return Rally.util.String.startsWith(e,"Could not parse ")});r.length&&(_.assign(i.resultSet,{count:0,records:[],total:0,totalRecords:0}),this._showInvalidQueryMessage(this.gridboard.getGridOrBoard(),r))},_showInvalidQueryMessage:function(e,t){e.noDataPrimaryText="Invalid Query",e.noDataSecondaryText=_.map(t,function(e){return"<div>"+e+"</div>"}).join("")},_getValidSorters:function(e){return _.filter(e,function(e){return _.any(this.models,function(t){var i=t.getField(e.property);return i&&i.sortable})},this)},_userHasPermissionsToEditPanelSettings:function(){return this.isEditable},_getColumnNamesFromState:function(e){return _(e&&e.columns).map(function(e){return _.isObject(e)?e.dataIndex:e}).compact().value()},_getTreeGridStore:function(){return e.create("Niks.apps.TreeStoreBuilder").build(_.merge({autoLoad:!1,childPageSizeEnabled:!0,context:this._getGridBoardContext().getDataContext(),enableHierarchy:!0,fetch:_.union(["Workspace"],this.columnNames),models:_.clone(this.models),pageSize:25,remoteSort:!0,root:{expanded:!0}},this.getGridStoreConfig())).then({success:function(e){return e.on("load",this._fireTreeGridReady,this,{single:!0}),{gridStore:e}},scope:this})}})}();

            Rally.launchApp('Niks.apps.CustomListApp', {
                name:"CustomDepList",
                parentRepos:"",
                version:"0.1.1"
            });

        });
    </script>


    <style type="text/css">
        
    </style>
</head>
<body>
</body>
</html>
